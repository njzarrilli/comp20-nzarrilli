
<!DOCTYPE html>

<html>

    <head>
        <title>Geolocation Map Example</title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true&amp;libraries=places"></script>
        <link rel="stylesheet" href="map-styling.css" />
        
        <script>
            var myLat = 0;
            var myLng = 0;
            var myLogin = "BobContreras";
            var xhr = new XMLHttpRequest();
            var me = new google.maps.LatLng(myLat, myLng);
            var myOptions = {
                        zoom: 13, // The larger the zoom number, the bigger the zoom
                        center: me,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    };
            var map;
            var marker;
            var infowindow = new google.maps.InfoWindow();
            var places;
            
            function init()
            {
                map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
                console.log("Call before getMyLocation()");
                getMyLocation();
                console.log("Call after getMyLocation()");
            }
            
            function getMyLocation() {
                console.log("In getMyLocation()");
                if (navigator.geolocation) { // the navigator.geolocation object is supported on your browser
                    navigator.geolocation.getCurrentPosition(function(position) {
                        myLat = position.coords.latitude;
                        myLng = position.coords.longitude;
                        sendLocation(myLat, myLng);
                        renderMap();
                    });
                }
                else {
                    alert("Geolocation is not supported by your web browser.  What a shame!");
                }
                console.log("Leaving getMyLocation()");
            }
            // function renderMap()
            // {
            //     me = new google.maps.LatLng(myLat, myLng);
                
            //     // Update map and go there...
            //     map.panTo(me);
    
            //     // Create a marker
            //     marker = new google.maps.Marker({
            //         position: me,
            //         title: myLogin,
            //         icon: 'kathleen.jpg'
            //     });
            //     marker.setMap(map);
                    
            //     // Open info window on click of marker
            //     google.maps.event.addListener(marker, 'click', function() {
            //         infowindow.setContent(marker.title);
            //         infowindow.open(map, marker);
            //     });
            // }
            
            // Taken from http://code.google.com/apis/maps/documentation/javascript/places.html
            // function callback(results, status)
            // {
            //     if (status == google.maps.places.PlacesServiceStatus.OK) {
            //         alert("Got places back!");
            //         places = results;
            //         for (var i = 0; i < results.length; i++) {
            //             createMarker(results[i]);
            //         }
            //     }
            // }
    
            // function createMarker(place)
            // {
            //     var placeLoc = place.geometry.location;
            //     var marker = new google.maps.Marker({
            //         map: map,
            //         position: place.geometry.location
            //     });
            //     google.maps.event.addListener(marker, 'click', function() {
            //         infowindow.close();
            //         infowindow.setContent(place.name);
            //         infowindow.open(map, this);
            //     });
            // }
            function sendLocation(myLat, myLng) 
            {
                xhr.open('POST', 'https://secret-about-box.herokuapp.com/sendLocation', true);
                var myLatString = myLat.toString();
                var myLngString = myLng.toString();
                var params = "login=" + myLogin + "&lat=" + myLat + "&lng=" + myLng;

                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr.onreadystatechange = parseData;
                xhr.send(params);
            }
            function parseData()
            {
                if (xhr.readyState ==4 && xhr.status == 200) {
                    me = new google.maps.LatLng(myLat, myLng);
                
                    // Update map and go there...
                    map.panTo(me);
    
                    // Create a marker
                        marker = new google.maps.Marker({
                        position: me,
                        title: myLogin,
                        icon: 'kathleen.jpg'
                    });
                    marker.setMap(map);
                    
                    // Open info window on click of marker
                    google.maps.event.addListener(marker, 'click', function() {
                        infowindow.setContent(myLogin);
                        infowindow.open(map, this);
                    });

                    converted = JSON.parse(xhr.responseText);
                    for (i = 0; i < converted.length; i++) {
                        var localID = converted[i]['login'];
                        var localLat = converted[i]['lat'];
                        var localLng = converted[i]['lng'];
                        var distance = haversine(myLat, myLng, localLat, localLng);
                        var myLatlng = new google.maps.LatLng(localLat,localLng);
                        var marker = new google.maps.Marker({
                            position: myLatlng,
                            map: map,
                            title: localID + ": " + distance.toString() + "miles away"
                        });
                        marker.setMap(map);
                        google.maps.event.addListener(marker, 'click', function() {
                            infowindow.setContent(this.title);
                            infowindow.open(map, this);
                        });
                    }
                }
            }
             function haversine (lat1, lon1, lat2, lon2) {
                var R = 6371; // km 
                var x1 = lat2-lat1;
                var dLat = x1.toRadians();
                var x2 = lon2-lon1;
                var dLon = x2.toRadians();  
                var a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
                                Math.cos(lat1.toRad()) * Math.cos(lat2.toRad()) * 
                                Math.sin(dLon/2) * Math.sin(dLon/2);  
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                var d = R * c;
                // need to: make a place, make the marker, show ids with markers,
                // show our icon
                return d;
            }
            Number.prototype.toRadians = function() {
                return this * Math.PI / 180;
            }
        </script>
    </head>
    
    <body onload="init()">
        <div id="map_canvas"></div>
    </body>
</html>